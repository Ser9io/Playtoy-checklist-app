<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playtoy Park - Menu Principal</title>

    <link rel="manifest" href="manifest.json">

<script>
    
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js') // Ponto adicionado aqui
        .then(reg => console.log('SW ativo!', reg.scope))
        .catch(err => console.log('Falha no SW:', err));
    });
  }
</script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Estilos Visuais */
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; text-align: center; background-color: #f0f2f5; margin: 0; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header-logo img { max-width: 220px; margin-bottom: 15px; }
        
        /* TELA DE ABERTURA (SPLASH SCREEN) */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 10000; 
            display: flex; align-items: center; justify-content: center; 
            transition: opacity 1s ease; /* Efeito de esmaecer */
        }

        /* TELA DE EXPLICA√á√ÉO (TUTORIAL) */
        #tutorialOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; align-items: center; justify-content: center; 
            color: white; padding: 20px; box-sizing: border-box;
        }

        /* ANIMA√á√ÉO ARCADE (PAC-MAN) */
        .arcade-bar { width: 100%; height: 55px; background: #000; position: relative; margin-bottom: 25px; border-radius: 12px; overflow: hidden; border: 3px solid #1a73e8; display: flex; align-items: center; }
        .game-group { position: absolute; display: flex; align-items: center; width: 220px; left: -250px; animation: percurso 10s linear infinite; }
        .pacman { background: yellow; border-radius: 50%; width: 22px; height: 22px; position: relative; animation: evolucaoPacman 10s step-end infinite; }
        .pacman::after { content: ""; border: 10px solid transparent; border-right: 10px solid #000; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: mouthAnim 0.3s ease infinite; }
        .ghost { width: 22px; height: 22px; margin: 0 5px; border-radius: 11px 11px 0 0; position: relative; }
        .red { background: red; } .pink { background: #ffb8ff; } .cyan { background: #00ffff; }
        
        @keyframes percurso { 0% { left: -250px; } 48% { left: 105%; } 50% { left: 105%; } 98% { left: -250px; } 100% { left: -250px; } }
        @keyframes evolucaoPacman { 0%, 49% { transform: scaleX(1); } 50%, 100% { transform: scaleX(-1); } }
        @keyframes mouthAnim { 0%, 100% { border-right-width: 12px; } 50% { border-right-width: 0px; } }
        
        /* MENU E BOT√ïES */
        .card-loja { background: #e8f0fe; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #1a73e8; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #1a73e8; font-size: 16px; }
        .grupo-titulo { background: #1a73e8; color: white; padding: 14px 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 15px; margin-top: 10px; font-weight: bold; cursor: pointer; border: none; width: 100%; }
        .maquinas-container { display: none; padding: 5px 10px 15px 15px; border-left: 5px solid #1a73e8; margin-bottom: 5px; background: #f8f9fa; border-radius: 0 0 10px 10px; }
        .btn-maquina { padding: 12px; margin: 8px 0; cursor: pointer; border-radius: 8px; border: none; background: #6c757d; color: white; font-weight: bold; width: 100%; text-align: left; display: block; }
        .btn-concluido { background: #28a745 !important; border-left: 10px solid #155724 !important; }
        
        .pdf-box { margin-top: 30px; padding: 20px; border: 2px dashed #1a73e8; border-radius: 15px; background: #f8fbff; }
        .btn-pdf { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 8px; color: white; }
    </style>
</head>
<body onload="carregarEstado()">

    <div id="splashScreen">
        <img src="logo_abertura.png" style="max-width: 80%; max-height: 80%; border-radius: 20px;">
    </div>

    <div id="tutorialOverlay">
        <div style="max-width: 400px; text-align: center;">
            <h2 style="color: #1a73e8; margin-bottom: 20px;">üéÆ Bem-vindo ao checklost das lojas Playtoy Park</h2>
            <div style="text-align: left; line-height: 1.8; font-size: 16px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                ‚Ä¢ <b>Logar:</b> Escolha a loja e use a senha.<br>
                ‚Ä¢ <b>Checklist:</b> Clique no nome da m√°quina.<br>
                ‚Ä¢ <b>Cor Verde:</b> Indica Checklist das m√°quinas j√° feita hoje.<br>
                ‚Ä¢ <b>Relat√≥rio:</b> Gere o PDF no bot√£o verde abaixo.<br>
                ‚Ä¢ <b>Observa√ß√µes:</b> Os PDF podem ser das m√°quinas que j√° tenham sido feitas os seus checklist ou da lista das m√°quinas que estejam com defeito.
            </div>
            <button onclick="fecharTutorial()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 25px; width: 100%;">ENTENDI, VAMOS L√Å!</button>
        </div>
    </div>

    <div class="container">
        <div class="header-logo"><img src="logo.png" alt="Playtoy Park"></div>
        
        <div class="arcade-bar">
            <div class="game-group">
                <div class="pacman"></div><div class="ghost red"></div><div class="ghost pink"></div><div class="ghost cyan"></div>
            </div>
        </div>

        <div class="card-loja">
            <label><strong>Unidade de Trabalho:</strong></label><br><br>
            <select id="seletorLoja" onchange="alternarLoja()">
                <option value="">-- Selecione a Loja --</option>
                <option value="Loja Carioca">Shopping Carioca</option>
                <option value="Loja Guadalupe">Shopping Guadalupe</option>
                <option value="Loja Partage">Shopping Partage</option>
            </select>
        </div>

        <div id="areaGrupos" style="display:none; text-align: left;">
            <div id="listaBotoes"></div>
            
            <div class="pdf-box">
                <h3>üìÑ Gerar Relat√≥rios</h3>
                <input type="date" id="dataRel" style="width:92%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
                <button class="btn-pdf" style="background:#28a745;" onclick="gerarPdf(false)">PDF Completo</button>
                <button class="btn-pdf" style="background:#dc3545;" onclick="gerarPdf(true)">PDF M√°quinas Paradas</button>
                <button class="btn-pdf" style="background:#6c757d;" onclick="limparTudo()">Limpar Hist√≥rico Local</button>
            </div>
        </div>
    </div>

<script>
/** 1. CONFIGURA√á√ÉO DE DADOS **/
const senhasLojas = { "Loja Carioca": "1111", "Loja Guadalupe": "2222", "Loja Partage": "3333" };

const estruturaPorLoja = {
    "Loja Carioca": {
        "GRUPO A: Fliperama": ["Multijogos Pandora"],
        "GRUPO B: Cabinadas": ["Jurassic Park", "Transformers"],
        "GRUPO C: Air Games": ["Air Hockey Pac-man A", "Air Hockey Pac-man B", "Air Hockey Pac-man C"],
        "GRUPO D: Kid Riders": ["Kid Rider Vs Drago", "Kid Rider Nemo", "Kid Rider Trem Azul", "Kid Rider Avi√£o Apache"],
        "GRUPO E: Gruas": ["Grua Dupla Neo Carnival", "Grua Simples Neo Carnival A", "Grua Simples Neo Carnival B", "Grua Max Claw", "Super Bicho Feliz", "Grua Top Machine"],
        "GRUPO F: Simuladores": ["Super Bikes 2 A", "Super Bikes 2 B", "Super Speed A", "Super Speed B", "Dead Head A", "Dead Head B", "Rilix"],
        "GRUPO G: Redemptions": ["Castle Attack", "Sonic Dash", "Sonho de Mel", "Duck Splash", "Astro Invasion", "Pirate Hook", "Super Wings", "MIB", "Ace Man", "Galaxy Travel", "Zumbi Land Battle", "Girafeplay", "Drago", "Rainbow", "Cyclone", "Pac Man Hammer", "Fright Night", "Super Soldier", "Happy Soccer", "Crazy Frog", "Fun In The Inks", "Dinosaur World", "Dinosaurs Park", "Duo Drive", "Street Basketball A", "Street Basketball B", "Bowling Champ"]
    },
    "Loja Guadalupe": {
        "GRUPO A: Fliperama": ["Multijogos Pandora", "The King 97"],
        "GRUPO B: Cabinadas": ["Deadstorn Pirates", "Aliens"],
        "GRUPO C: Air Games": ["Air Game Presas", "Air Game Malware A", "Air Game Malware B", "Air Game Malware C"],
        "GRUPO D: Kid Riders": ["Kid Rider Race Space", "Kid Rider TD", "Kid Rider Jeep Azul", "Kid Rider Carro Vermelho", "Kid Rider Carro Amarelo"],
        "GRUPO E: Gruas": ["Grua Dupla Neo Carnival 267 A e B", "Grua Simples Neo Carnival 268 A e B"],
        "GRUPO F: Simuladores": ["Daytona USA A (Galp√£o)", "Daytona USA B (Galp√£o)", "Daytona USA A (Esportivo)", "Daytona USA B (Esportivo)", "Cruisis World 50", "Cruisis USA A", "Cruisis USA B", "Midnight Run", "Wave Runner", "Wave Shark", "Off Road challenge", "Manx TT A", "Manx TT B", "Drift A", "Drift B", "Need For Speed Carbon A", "Need For Speed Carbon B", "Seninha", "S√£o Francisco Rush", "Super bikes 2", "Nicktoons Nitro A", "Nicktoons Nitro B", "Wack Race A", "Wack Race B", "Sonic All Star Race", "Out Run 2"],
        "GRUPO G: Redemptions": ["Sonho de Mel", "Galaxy Travel", "Drago", "Fright Night", "Street Basketball A", "Street Basketball B", "Ghost Bowling", "Ice Ball", "Castelo do Monstro", "Zombie Outbreak", "Hammer 2", "Wacky Gator", "Hoop It Up", "Seeking Treasute", "Hipo Jungle", "Corrida Maluca", "Diverkids", "Ocean Panic", "Street Basketball Vermelha", "Ataque dos Tubar√µes", "Feed Fido", "Target Zero", "Fishing Fun", "Mouse Attack"],
        "GRUPO H: Tot√≥": ["Playgol"],
        "GRUPO I: Coletivos": ["Auto Pista Bate-bate", "Peixinho"],
        "GRUPO J: Galeria": ["Saloon", "Patrulha Estelar"]
    },
    "Loja Partage": {
        "GRUPO A: Fliperama": ["Multijogos Pandora", "The King 2002"],
        "GRUPO B: Cabinadas": ["Jurassic Park", "Transformers", "The House of the Dead 4"],
        "GRUPO C: Air Games": ["Air Hockey Pac-man A", "Air Hockey Pac-man B", "Air Game Free Style", "Air Game Presas"],
        "GRUPO D: Kid Riders": ["Kid Rider Train", "Kid Rider Jet Skee Amarelo", "Kid Rider Barco Pirata", "Kid Rider Carro Galo", "Kid Rider Carr√£o Azul", "Kid Rider Carro Amarelo"],
        "GRUPO E: Gruas": ["Grua Simples Neo Carnival 181", "Grua Simples Neo Carnival 183", "Grua Simples Neo Carnival 381", "Grua Simples Neo Carnival 384", "Super Bicho Feliz", "Grua Top Modern Game"],
        "GRUPO F: Simuladores": ["Aliens Extermination", "Guitar Hero", "Pump Fiesta 2010", "Super Bikes 2 A", "Super Bikes 2 B", "Dead Head A", "Dead Head B", "Rilix", "Daytona USA A", "Daytona USA B", "Daytona USA A (Esportivo)", "Daytona USA B (Esportivo)", "Sega Rally A", "Sega Rally B", "Cruisis USA", "Sonic All Star Race", "ATV Track"],
        "GRUPO G: Redemptions": ["Sonho de Mel", "Ace Man", "Drago", "Cyclone", "Pac Man Hammer", "Happy Soccer", "Street Basketball A", "Street Basketball B", "Bowling Champ", "Chuva de Bolinha", "Fire Heros", "Surfin Ducks", "Corrida Maluca", "Rescue One!", "Patati Patat√°", "Saltin Ball", "Hipo Jungle", "Bionic Basketball", "Street Basketball Vermelha", "Kung Fu Panda", "Wild West", "Atl√¢ntida", "NBA Championships"],
        "GRUPO H: Tot√≥": ["Futeboys"],
        "GRUPO I: Coletivos": ["Auto Pista Bate-bate"],
        "GRUPO J: Galeria": ["Toy Town"]		
    }
};

/** 2. L√ìGICA DE ABERTURA E TUTORIAL **/

function fecharTutorial() {
    document.getElementById("tutorialOverlay").style.display = "none";
    sessionStorage.setItem("tutorialLido", "sim");
}

function carregarEstado() {
    const splash = document.getElementById("splashScreen");
    
    // VERIFICA√á√ÉO: Se j√° viu o splash nesta sess√£o, remove ele imediatamente
    if (sessionStorage.getItem("splashVisto") === "sim") {
        splash.style.display = "none";
    } else {
        // Se √© a primeira vez abrindo o app agora:
        setTimeout(() => {
            splash.style.opacity = "0";
            setTimeout(() => {
                splash.style.display = "none";
                sessionStorage.setItem("splashVisto", "sim"); // Marca como visto
            }, 1000);
        }, 3000);
    }

    // Controle do Tutorial (J√° existente no seu c√≥digo)
    if (sessionStorage.getItem("tutorialLido") === "sim") {
        document.getElementById("tutorialOverlay").style.display = "none";
    }

    // Configura√ß√µes iniciais de data e loja
    document.getElementById("dataRel").value = new Date().toLocaleDateString('sv-SE');
    const lojaSalva = localStorage.getItem("lojaAtiva");
    if (lojaSalva) { 
        document.getElementById("seletorLoja").value = lojaSalva; 
        renderizarBotoes(lojaSalva); 
    }
}

/** 3. INTERFACE E MENU **/

function renderizarBotoes(loja) {
    const lista = document.getElementById("listaBotoes");
    document.getElementById("areaGrupos").style.display = "block";
    const hoje = new Date().toLocaleDateString('sv-SE'); 
    const hist = JSON.parse(localStorage.getItem("historicoChecklist")) || [];
    const grupos = estruturaPorLoja[loja] || {};
    
    let html = "";
    let i = 0;

    for (const [nomeGrupo, maquinas] of Object.entries(grupos)) {
        i++;
        
        // --- L√ìGICA DO CONTADOR ---
        let concluidas = 0;
        const total = maquinas.length;
        
        // Gerar o HTML das m√°quinas primeiro para contar
        let maquinasHtml = "";
        maquinas.forEach(m => {
            const feito = hist.some(r => r.loja === loja && r.equipamento.toUpperCase() === m.toUpperCase() && r.data === hoje);
            if (feito) concluidas++;
            
            maquinasHtml += `<button class="btn-maquina ${feito ? 'btn-concluido' : ''}" onclick="ir('${m}', '${loja}')">
                ${feito ? '‚úÖ ' : ''}${m}
            </button>`;
        });

        // Define a cor do contador: se concluiu tudo, fica verde claro ou destaque
        const corContador = (concluidas === total) ? '#28a745' : '#ffffff';

        // Cabe√ßalho do Grupo com o Contador
        html += `
            <button class="grupo-titulo" onclick="toggleGrupo('g-${i}')">
                <span>üìÇ ${nomeGrupo}</span>
                <span style="background: ${corContador}; color: #1a73e8; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px;">
                    ${concluidas}/${total}
                </span>
                <span id="seta-g-${i}" style="margin-left: auto;">‚ñº</span>
            </button>`;
        
        html += `<div id="g-${i}" class="maquinas-container">${maquinasHtml}</div>`;
    }
    lista.innerHTML = html;
}

function toggleGrupo(id) {
    const el = document.getElementById(id);
    const seta = document.getElementById("seta-" + id);
    const aberto = el.style.display === "block";
    el.style.display = aberto ? "none" : "block";
    seta.innerText = aberto ? "‚ñº" : "‚ñ≤";
}

function alternarLoja() {
    const sel = document.getElementById("seletorLoja");
    const loja = sel.value;
    
    // Se o usu√°rio clicar no "Selecione a Loja" (valor vazio), n√£o faz nada
    if (!loja) return;
    
    const senhaDigitada = prompt(`Senha para ${loja}:`);

    // Verifica se a senha est√° correta
    if (senhaDigitada === senhasLojas[loja]) {
        localStorage.setItem("lojaAtiva", loja);
        renderizarBotoes(loja);
    } else { 
        // Se a senha estiver errada OU se o usu√°rio clicar em "Cancelar"
        if (senhaDigitada !== null) {
            alert("Senha Incorreta!"); 
        }
        
        // RESET: Volta o select para o estado inicial
        sel.value = ""; 
        
        // Opcional: Se quiser esconder a √°rea de grupos caso a senha falhe
        document.getElementById("areaGrupos").style.display = "none";
        localStorage.removeItem("lojaAtiva");
    }
}

function ir(m, l) { 
    window.location.href = `checklist.html?maq=${encodeURIComponent(m)}&loja=${encodeURIComponent(l)}`; 
}

function limparTudo() {
    if (prompt("Senha Master:") === "9999") { 
        if(confirm("Apagar todo hist√≥rico?")) { 
            localStorage.removeItem("historicoChecklist"); 
            location.reload(); 
        }
    }
}

/** 4. GERA√á√ÉO DE PDF **/
async function gerarPdf(soParadas) {
    try {
        const { jsPDF } = window.jspdf || window;
        const doc = new jsPDF();
        const loja = document.getElementById("seletorLoja").value;
        const data = document.getElementById("dataRel").value;
        const hist = JSON.parse(localStorage.getItem("historicoChecklist")) || [];
        
        let registros = hist.filter(r => r.loja === loja && r.data === data);
        if (soParadas) registros = registros.filter(r => r.itens[0].resposta === "N√£o");
        
        if (registros.length === 0) return alert("Nada encontrado.");

        let y = 15;
        doc.setFontSize(16);
        doc.text(`PLAYTOY - ${loja} (${data})`, 10, y);
        y += 12;


for (let r of registros) {
            if (y > 260) { doc.addPage(); y = 20; }
            
            // T√≠tulo da M√°quina (Azul escuro)
            doc.setFontSize(11);
            doc.setTextColor(26, 115, 232); // Cor azul #1a73e8
            doc.setFont(undefined, 'bold');
            doc.text(`M√ÅQUINA: ${r.equipamento}`, 10, y);
            
            // Nome do T√©cnico (Preto e Negrito)
            doc.setTextColor(0, 0, 0); // Volta para o preto
            const larguraMaq = doc.getTextWidth(`M√ÅQUINA: ${r.equipamento} `);
            doc.setFontSize(9);
            doc.text(`| T√©cnico: ${r.responsavel}`, 10 + larguraMaq, y);
            
            y += 7;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60); // Cinza para os itens

            if (!soParadas) {
                r.itens.forEach(item => { 
                    if (y > 275) { doc.addPage(); y = 20; }
                    // Destaca respostas "N√£o" em vermelho no PDF
                    if(item.resposta === "N√£o") {
                        doc.setTextColor(220, 53, 69);
                    } else {
                        doc.setTextColor(60, 60, 60);
                    }
                    doc.text(`‚Ä¢ ${item.pergunta}: ${item.resposta}`, 15, y); 
                    y += 6; 
                });
                
                doc.setTextColor(0, 0, 0); // Reseta para preto

                if (r.fotos && r.fotos.length > 0) {
                    let xF = 15;
                    y += 2;
                    for (let f of r.fotos) {
                        if (y > 230) { doc.addPage(); y = 20; }
                        try {
                            doc.addImage(f, 'JPEG', xF, y, 40, 40);
                            xF += 45; 
                            if (xF > 160) { xF = 15; y += 45; }
                        } catch (e) { console.error(e); }
                    }
                    y = (xF === 15) ? y : y + 50;
                }

                if(r.comentarioFoto) { 
                    if (y > 265) { doc.addPage(); y = 20; }
                    doc.setFont(undefined, 'bold');
                    doc.text("OBSERVA√á√ïES T√âCNICAS:", 15, y);
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    
                    const linhas = doc.splitTextToSize(r.comentarioFoto, 180);
                    linhas.forEach(l => {
                        if (y > 280) { doc.addPage(); y = 20; }
                        doc.text(l, 15, y);
                        y += 6;
                    });
                }
                y += 8; 
                doc.setDrawColor(200, 200, 200);
                doc.line(10, y - 4, 200, y - 4); // Linha divis√≥ria entre m√°quinas
            } else { 
                y += 5; 
            }
        }
        
        const nomeFinal = (soParadas ? "Paradas_" : "Geral_") + loja.replace(/\s+/g, '_') + "_" + data + ".pdf";
        doc.save(nomeFinal);

    } catch (err) { 
        console.error(err);
        alert("Erro no PDF."); 
    }
}
</script>
</body>
</html>